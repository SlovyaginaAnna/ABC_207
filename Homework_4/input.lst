     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fscanf
     4                                  
     5                                  extern FISH
     6                                  extern BIRD
     7                                  extern BEAST
     8                                  
     9                                  global InFish
    10                                  InFish:
    11                                  section .data
    12 00000000 25732564256400              .infmt db "%s%d%d",0
    13                                  section .bss
    14 00000000 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    15 00000008 <res 00000008>              .pfish  resq    1   ; адрес рыбы
    16                                  section .text
    17 00000000 55                      push rbp
    18 00000001 4889E5                  mov rbp, rsp
    19                                  
    20                                      ; Сохранение принятых аргументов
    21 00000004 48893C25[08000000]          mov     [.pfish], rdi          ; сохраняется адрес рыбы
    22 0000000C 48893425[00000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    23                                  
    24                                      ; Ввод рыбы из файла
    25 00000014 488B3C25[00000000]          mov     rdi, [.FILE]
    26 0000001C 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    26 0000001E [0000000000000000] 
    27 00000026 488B1425[08000000]          mov     rdx, [.pfish]      
    28 0000002E 488B0C25[08000000]          mov     rcx, [.pfish]
    29 00000036 4883C104                    add     rcx, 4  
    30 0000003A 4C8B0425[08000000]          mov     r8, [.pfish]
    31 00000042 4983C008                    add     r8, 8                 
    32 00000046 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    33 0000004B E8(00000000)                call    fscanf
    34                                  
    35 00000050 C9                      leave
    36 00000051 C3                      ret
    37                                  
    38                                  global InBird
    39                                  InBird:
    40                                  section .data
    41 00000007 25732564256400              .infmt db "%s%d%d",0
    42                                  section .bss
    43 00000010 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    44 00000018 <res 00000008>              .pbird  resq    1   ; адрес рыбы
    45                                  section .text
    46 00000052 55                      push rbp
    47 00000053 4889E5                  mov rbp, rsp
    48                                  
    49                                      ; Сохранение принятых аргументов
    50 00000056 48893C25[18000000]          mov     [.pbird], rdi          ; сохраняется адрес рыбы
    51 0000005E 48893425[10000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    52                                  
    53                                      ; Ввод рыбы из файла
    54 00000066 488B3C25[10000000]          mov     rdi, [.FILE]
    55 0000006E 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    55 00000070 [0700000000000000] 
    56 00000078 488B1425[18000000]          mov     rdx, [.pbird]      
    57 00000080 488B0C25[18000000]          mov     rcx, [.pbird]
    58 00000088 4883C104                    add     rcx, 4  
    59 0000008C 4C8B0425[18000000]          mov     r8, [.pbird]
    60 00000094 4983C008                    add     r8, 8                 
    61 00000098 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    62 0000009D E8(00000000)                call    fscanf
    63                                  
    64 000000A2 C9                      leave
    65 000000A3 C3                      ret
    66                                  
    67                                  global InBeast
    68                                  InBeast:
    69                                  section .data
    70 0000000E 25732564256400              .infmt db "%s%d%d",0
    71                                  section .bss
    72 00000020 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    73 00000028 <res 00000008>              .pbeast  resq    1   ; адрес рыбы
    74                                  section .text
    75 000000A4 55                      push rbp
    76 000000A5 4889E5                  mov rbp, rsp
    77                                  
    78                                      ; Сохранение принятых аргументов
    79 000000A8 48893C25[28000000]          mov     [.pbeast], rdi          ; сохраняется адрес рыбы
    80 000000B0 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    81                                  
    82                                      ; Ввод рыбы из файла
    83 000000B8 488B3C25[20000000]          mov     rdi, [.FILE]
    84 000000C0 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    84 000000C2 [0E00000000000000] 
    85 000000CA 488B1425[28000000]          mov     rdx, [.pbeast]      
    86 000000D2 488B0C25[28000000]          mov     rcx, [.pbeast]
    87 000000DA 4883C104                    add     rcx, 4  
    88 000000DE 4C8B0425[28000000]          mov     r8, [.pbeast]
    89 000000E6 4983C008                    add     r8, 8                 
    90 000000EA B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    91 000000EF E8(00000000)                call    fscanf
    92                                  
    93 000000F4 C9                      leave
    94 000000F5 C3                      ret
    95                                  
    96                                  global InAnimal
    97                                  InAnimal:
    98                                  section .data
    99 00000015 256400                      .tagFormat   db      "%d",0
   100 00000018 5461672069733A2025-         .tagOutFmt   db     "Tag is: %d",10,0
   100 00000021 640A00             
   101                                  section .bss
   102 00000030 <res 00000008>              .FILE       resq    1   ; временное хранение указателя на файл
   103 00000038 <res 00000008>              .panimal     resq    1   ; адрес животного
   104 00000040 <res 00000004>              .animalTag   resd    1   ; признак животного
   105                                  section .text
   106 000000F6 55                      push rbp
   107 000000F7 4889E5                  mov rbp, rsp
   108                                  
   109                                      ; Сохранение принятых аргументов
   110 000000FA 48893C25[38000000]          mov     [.panimal], rdi          ; сохраняется адрес животного
   111 00000102 48893425[30000000]          mov     [.FILE], rsi            ; сохраняется указатель на файл
   112                                  
   113                                      ; чтение признака животного и его обработка
   114 0000010A 488B3C25[30000000]          mov     rdi, [.FILE]
   115 00000112 48BE-                       mov     rsi, .tagFormat
   115 00000114 [1500000000000000] 
   116 0000011C 488B1425[38000000]          mov     rdx, [.panimal]      ; адрес начала животного (ее признак)
   117 00000124 4831C0                      xor     rax, rax            ; нет чисел с плавающей точкой
   118 00000127 E8(00000000)                call    fscanf
   119                                      
   120 0000012C 488B0C25[38000000]          mov rcx, [.panimal]          ; загрузка адреса начала животного
   121 00000134 8B01                        mov eax, [rcx]              ; и получение прочитанного признака
   122 00000136 3B0425[00000000]            cmp eax, [FISH]
   123 0000013D 7416                        je .fishIn
   124 0000013F 3B0425[00000000]            cmp eax, [BIRD]
   125 00000146 742D                        je .birdIn
   126 00000148 3B0425[00000000]            cmp eax, [BEAST]
   127 0000014F 7442                        je .beastIn
   128 00000151 31C0                        xor eax, eax    ; Некорректный признак - обнуление кода возврата
   129 00000153 EB5C                        jmp     .return
   130                                  .fishIn:
   131                                      ; Ввод рыбы
   132 00000155 488B3C25[38000000]          mov     rdi, [.panimal]
   133 0000015D 4883C704                    add     rdi, 4
   134 00000161 488B3425[30000000]          mov     rsi, [.FILE]
   135 00000169 E892FEFFFF                  call    InFish
   136 0000016E B801000000                  mov     rax, 1  ; Код возврата - true
   137 00000173 EB3C                        jmp     .return
   138                                  .birdIn:
   139                                      ; Ввод птицы
   140 00000175 488B3C25[38000000]          mov     rdi, [.panimal]
   141 0000017D 4883C704                    add     rdi, 4
   142 00000181 488B3425[30000000]          mov     rsi, [.FILE]
   143 00000189 E8C4FEFFFF                  call    InBird
   144 0000018E B801000000                  mov     rax, 1  ; Код возврата - true
   145                                  .beastIn:
   146                                      ; Ввод зверя
   147 00000193 488B3C25[38000000]          mov     rdi, [.panimal]
   148 0000019B 4883C704                    add     rdi, 4
   149 0000019F 488B3425[30000000]          mov     rsi, [.FILE]
   150 000001A7 E8F8FEFFFF                  call    InBeast
   151 000001AC B801000000                  mov     rax, 1  ; Код возврата - true
   152                                  .return:
   153                                  
   154 000001B1 C9                      leave
   155 000001B2 C3                      ret
   156                                  
   157                                  global InContainer
   158                                  InContainer:
   159                                  section .bss
   160 00000044 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   161 0000004C <res 00000008>              .plen   resq    1   ; адрес для сохранения числа введенных элементов
   162 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   163                                  section .text
   164 000001B3 55                      push rbp
   165 000001B4 4889E5                  mov rbp, rsp
   166                                  
   167 000001B7 48893C25[44000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   168 000001BF 48893425[4C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   169 000001C7 48891425[54000000]          mov [.FILE], rdx    ; сохраняется указатель на файл
   170                                      ; В rdi адрес начала контейнера
   171 000001CF 4831DB                      xor rbx, rbx        ; число животных = 0
   172 000001D2 4889D6                      mov rsi, rdx        ; перенос указателя на файл
   173                                  .loop:
   174                                      ; сохранение рабочих регистров
   175 000001D5 57                          push rdi
   176 000001D6 53                          push rbx
   177                                  
   178 000001D7 488B3425[54000000]          mov     rsi, [.FILE]
   179 000001DF B800000000                  mov     rax, 0      ; нет чисел с плавающей точкой
   180 000001E4 E80DFFFFFF                  call    InAnimal     ; ввод животного
   181 000001E9 4883F800                    cmp rax, 0          ; проверка успешности ввода
   182 000001ED 7E0B                        jle  .return        ; выход, если признак меньше или равен 0
   183                                  
   184 000001EF 5B                          pop rbx
   185 000001F0 48FFC3                      inc rbx
   186                                  
   187 000001F3 5F                          pop rdi
   188 000001F4 4883C710                    add rdi, 16             ; адрес следующего животного
   189                                  
   190 000001F8 EBDB                        jmp .loop
   191                                  .return:
   192 000001FA 488B0425[4C000000]          mov rax, [.plen]    ; перенос указателя на длину
   193 00000202 8918                        mov [rax], ebx      ; занесение длины
   194 00000204 C9                      leave
   195 00000205 C3                      ret
